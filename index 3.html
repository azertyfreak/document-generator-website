<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verkoopovereenkomst — Formulier (Debug)</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa; --ok:#065f46; --err:#991b1b; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: var(--bg); }
    h1 { margin: 0 0 8px 0; }
    .card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
    label { display:block; font-weight:600; margin-top:10px; }
    input, textarea, select, button { width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); font-size:14px; }
    button { background:#111827; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .row { display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 1000px) { .row { grid-template-columns: 1fr 1fr; } }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .muted { color: var(--muted); }
    .ok { color: var(--ok); }
    .err { color: var(--err); white-space: pre-wrap; }
    .section { border:1px dashed var(--border); border-radius:10px; padding:12px; margin-top:12px; }
    .spinner { display:inline-block; width:18px; height:18px; border:3px solid #ddd; border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; margin-left:8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>Verkoopovereenkomst — Formulier (Debug)</h1>
  <div class="muted">Deze versie toont extra foutdetails (CORS, mixed content, netwerkproblemen) om koppelen met je Render API eenvoudig te krijgen.</div>

  <div class="card">
    <label>API Base URL (Render)</label>
    <input id="apiBase" placeholder="https://jouw-api.onrender.com"/>
    <div class="muted" style="margin-top:6px;">Voorbeeld: <code>https://verkoopovereenkomst.onrender.com</code></div>
    <div class="actions" style="margin-top:10px;">
      <button id="btnHealth">Health-check</button>
      <button id="btnLoadSchema">Laad schema</button>
      <button id="btnExample">Voorbeeld invullen</button>
      <span id="loading" style="display:none" class="spinner" aria-label="Bezig..."></span>
    </div>
    <div id="tip" class="muted" style="margin-top:8px;"></div>
    <div id="status" style="margin-top:8px;"></div>
  </div>

  <div id="formCard" class="card" style="display:none;">
    <h2 style="margin:0 0 8px 0;">Formulier</h2>
    <div id="sections"></div>
    <div class="actions" style="margin-top:12px;">
      <button id="btnValidate">Controleer invoer</button>
      <button id="btnGenerate">Genereer DOCX</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <details>
      <summary>Geavanceerd & Debug</summary>
      <label>JSON</label>
      <textarea id="jsonOut" style="min-height:240px;"></textarea>
      <label>Validatiefouten</label>
      <pre id="errorsBox" class="err" style="min-height:120px;"></pre>
      <div class="actions" style="margin-top:8px;">
        <button id="btnFormToJson">Formulier → JSON</button>
        <button id="btnJsonToForm">JSON → Formulier</button>
      </div>
      <div style="margin-top:10px" class="muted">
        Zie ook de browser-console (F12 → Console) voor extra logs. Controleer dat je API-URL met <code>https://</code> start en geen spaties bevat.
      </div>
    </details>
  </div>

<script>
let schema = null;

function setLoading(on) {
  document.getElementById("loading").style.display = on ? "inline-block" : "none";
  for (const id of ["btnHealth","btnLoadSchema","btnExample"]) {
    const el = document.getElementById(id);
    el.disabled = on;
  }
}

function showStatus(type, text) {
  const s = document.getElementById("status");
  s.className = type === "ok" ? "ok" : (type === "err" ? "err" : "muted");
  s.textContent = text;
}

function showTip(text) {
  document.getElementById("tip").textContent = text || "";
}

function normalizeBaseUrl(url) {
  if (!url) return "";
  url = url.trim();
  if (url.endsWith("/")) url = url.slice(0, -1);
  return url;
}

function mixedContentWarning(apiBase) {
  try {
    if (location.protocol === "https:" && apiBase.startsWith("http:")) {
      return "Je site is HTTPS maar je API is HTTP. Browsers blokkeren mixed content. Zet je API op https:// of host de site ook op http:// voor test.";
    }
  } catch {}
  return "";
}

function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === "class") e.className = v;
    else if (k === "for") e.htmlFor = v;
    else e.setAttribute(k, v);
  }
  for (const c of [].concat(children)) {
    if (typeof c === "string") e.appendChild(document.createTextNode(c));
    else if (c) e.appendChild(c);
  }
  return e;
}
function fieldId(path) { return "f_" + path.join("__"); }

function renderField(path, key, propSchema) {
  const id = fieldId(path.concat([key]));
  const label = el("label", {"for": id}, [key.replaceAll("_"," ")]);
  let input;
  let t = propSchema.type;
  if (Array.isArray(t)) t = t[0];

  if (t === "boolean") input = el("input", {type:"checkbox", id});
  else if (t === "number" || t === "integer") input = el("input", {type:"number", id, step:"any"});
  else if (t === "string" && propSchema.format === "date") input = el("input", {type:"date", id});
  else if (t === "string" && propSchema.format === "email") input = el("input", {type:"email", id});
  else if (t === "string" && propSchema.enum) {
    const sel = el("select", {id});
    sel.appendChild(el("option", {value:""}, ["— kies —"]));
    for (const opt of propSchema.enum) sel.appendChild(el("option", {value:String(opt)}, [String(opt)]));
    input = sel;
  } else if (t === "string") input = el("input", {type:"text", id});
  else if (t === "object") return renderObject(path.concat([key]), propSchema, key);
  else input = el("input", {type:"text", id});

  return el("div", {}, [label, input]);
}

function renderObject(path, objSchema, title) {
  const section = el("div", {class:"section"});
  section.appendChild(el("h3", {}, [title.replaceAll("_"," ")]));
  const grid = el("div", {class:"grid"});
  section.appendChild(grid);
  const props = objSchema.properties || {};
  for (const [k, v] of Object.entries(props)) {
    if (v && v.type === "object") grid.appendChild(renderObject(path.concat([k]), v, k));
    else grid.appendChild(renderField(path, k, v || {}));
  }
  return section;
}

function buildForm(s) {
  const sections = document.getElementById("sections");
  sections.innerHTML = "";
  const props = s.properties || {};
  for (const [k, v] of Object.entries(props)) {
    sections.appendChild(renderObject([k], v, k));
  }
  document.getElementById("formCard").style.display = "block";
}

function setValueByPath(path, value) {
  const id = fieldId(path);
  const input = document.getElementById(id);
  if (!input) return;
  if (input.type === "checkbox") input.checked = Boolean(value);
  else input.value = value == null ? "" : value;
}
function getValueByPath(path) {
  const id = fieldId(path);
  const input = document.getElementById(id);
  if (!input) return undefined;
  if (input.type === "checkbox") return input.checked;
  if (input.type === "number") return input.value ? Number(input.value) : undefined;
  return input.value || undefined;
}
function objFromSchema(objSchema, basePath) {
  const props = objSchema.properties || {};
  const out = {};
  for (const [k, v] of Object.entries(props)) {
    if (v && v.type === "object") out[k] = objFromSchema(v, basePath.concat([k]));
    else {
      const val = getValueByPath(basePath.concat([k]));
      if (val !== undefined) out[k] = val;
    }
  }
  return out;
}
function fillFormFromObject(obj, basePath=[]) {
  for (const [k, v] of Object.entries(obj || {})) {
    if (v && typeof v === "object" && !Array.isArray(v)) fillFormFromObject(v, basePath.concat([k]));
    else setValueByPath(basePath.concat([k]), v);
  }
}

async function call(apiBase, path, opts={}) {
  const url = apiBase + path;
  console.log("Fetch:", url, opts);
  const res = await fetch(url, Object.assign({mode:"cors"}, opts));
  const info = { status: res.status, statusText: res.statusText, ok: res.ok, url: res.url };
  console.log("Response:", info);
  return { res, info };
}

document.getElementById("btnHealth").addEventListener("click", async () => {
  const apiBase = normalizeBaseUrl(document.getElementById("apiBase").value);
  if (!apiBase) { showStatus("err", "Vul eerst je API Base URL in."); return; }
  const warn = mixedContentWarning(apiBase);
  showTip(warn);
  setLoading(true);
  try {
    const {res, info} = await call(apiBase, "/health");
    const text = await res.text();
    if (info.ok && text.trim() === "ok") showStatus("ok", "Health ✓ — API is bereikbaar.");
    else showStatus("err", "Health-check faalde: " + info.status + " " + info.statusText + " — " + text);
  } catch (e) {
    console.error(e);
    showStatus("err", "Netwerkfout (health): " + e.message);
  } finally { setLoading(false); }
});

document.getElementById("btnLoadSchema").addEventListener("click", async () => {
  const apiBase = normalizeBaseUrl(document.getElementById("apiBase").value);
  if (!apiBase) { showStatus("err", "Vul eerst je API Base URL in."); return; }
  const warn = mixedContentWarning(apiBase);
  showTip(warn);
  setLoading(true);
  try {
    const {res, info} = await call(apiBase, "/schema");
    if (!info.ok) {
      const text = await res.text();
      showStatus("err", "Schema laden mislukt: " + info.status + " " + info.statusText + "\n" + text);
      return;
    }
    schema = await res.json();
    buildForm(schema);
    showStatus("ok", "Schema geladen ✓");
  } catch (e) {
    console.error(e);
    showStatus("err", "Netwerk/CORS fout: " + e.message + "\nZie browser-console voor details.");
  } finally { setLoading(false); }
});

document.getElementById("btnExample").addEventListener("click", () => {
  const example = {
    "makelaar": {"naam":"Jan Jansen","biv_nummer":"123456","kantoor":"Immo Jansen","straat":"Stationsstraat","nummer":"12","postcode":"1000","gemeente":"Brussel"},
    "verkoper": {"natuurlijk_persoon": true, "naam":"Piet","voornaam":"Pieter","contact":{"email":"piet@example.com","telefoonnummer":"012345678"}},
    "koper": {"natuurlijk_persoon": true, "naam":"Klara","voornaam":"Klaartje","contact":{"email":"klara@example.com","telefoonnummer":"098765432"}},
    "goed": {"straat":"Dorpsplein","nummer":"1","postcode":"8500","gemeente":"Kortrijk","land":"België","aard":"Woning"},
    "prijs": {"totaal":350000,"voorschot":{"bedrag":35000,"overschrijving":true,"als_voorschot":true},"saldo_koopsom":315000},
    "genot":{"niet_verhuurd": true},
    "roerende_goederen":{"geen": true}
  };
  fillFormFromObject(example, []);
  document.getElementById("jsonOut").value = JSON.stringify(example, null, 2);
});

document.getElementById("btnFormToJson").addEventListener("click", () => {
  if (!schema) { alert("Laad eerst het schema."); return; }
  const ctx = objFromSchema(schema, []);
  document.getElementById("jsonOut").value = JSON.stringify(ctx, null, 2);
});

document.getElementById("btnJsonToForm").addEventListener("click", () => {
  try {
    const obj = JSON.parse(document.getElementById("jsonOut").value);
    fillFormFromObject(obj, []);
  } catch (e) {
    alert("JSON is ongeldig: " + e.message);
  }
});

async function validateContext(apiBase, ctx) {
  const {res, info} = await call(apiBase, "/validate", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({context: ctx})
  });
  if (info.ok) return {ok:true, errors:[]};
  let text = await res.text();
  try {
    const j = JSON.parse(text);
    return {ok:false, errors:j.detail || [j]};
  } catch { return {ok:false, errors:[{message:text}]}; }
}

async function generateDocx(apiBase, ctx) {
  const {res, info} = await call(apiBase, "/genereer/docx", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({context: ctx})
  });
  if (!info.ok) {
    const text = await res.text();
    throw new Error("Genereren mislukt: " + info.status + " " + info.statusText + "\n" + text);
  }
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "overeenkomst.docx";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

document.getElementById("btnValidate").addEventListener("click", async () => {
  const apiBase = normalizeBaseUrl(document.getElementById("apiBase").value);
  const msg = document.getElementById("msg");
  if (!schema) { msg.className="err"; msg.textContent="Laad eerst het schema."; return; }
  const ctx = objFromSchema(schema, []);
  try {
    const v = await validateContext(apiBase, ctx);
    if (v.ok) { msg.className="ok"; msg.textContent="Valide ✓"; document.getElementById("errorsBox").textContent=""; }
    else {
      msg.className="err"; msg.textContent="Fouten gevonden.";
      const lines = v.errors.map(e => `• ${e.path || ""} — ${e.message || JSON.stringify(e)}`);
      document.getElementById("errorsBox").textContent = lines.join("\n");
    }
    document.getElementById("jsonOut").value = JSON.stringify(ctx, null, 2);
  } catch (e) { msg.className="err"; msg.textContent="Validatie fout: " + e.message; }
});

document.getElementById("btnGenerate").addEventListener("click", async () => {
  const apiBase = normalizeBaseUrl(document.getElementById("apiBase").value);
  const msg = document.getElementById("msg");
  if (!schema) { msg.className="err"; msg.textContent="Laad eerst het schema."; return; }
  const ctx = objFromSchema(schema, []);
  try {
    const v = await validateContext(apiBase, ctx);
    if (!v.ok) {
      msg.className="err"; msg.textContent="Corrigeer de fouten vóór genereren (zie onder).";
      const lines = v.errors.map(e => `• ${e.path || ""} — ${e.message || JSON.stringify(e)}`);
      document.getElementById("errorsBox").textContent = lines.join("\n");
      document.getElementById("jsonOut").value = JSON.stringify(ctx, null, 2);
      return;
    }
    await generateDocx(apiBase, ctx);
    msg.className="ok"; msg.textContent="DOCX gegenereerd ✓";
  } catch (e) { msg.className="err"; msg.textContent = e.message; }
});
</script>
</body>
</html>
