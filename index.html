<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verkoopovereenkomst — Volledig formulier</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --accent:#1f2937; --bg:#fafafa; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: var(--bg); }
    h1 { margin: 0 0 6px 0; }
    .muted { color: var(--muted); }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1000px) { .row { grid-template-columns: 1fr 1fr; } }
    .card { border: 1px solid var(--border); border-radius: 12px; background: white; padding: 16px; }
    .section { border: 1px dashed var(--border); border-radius: 10px; padding: 14px; margin-top:12px; background:#fff; }
    .section h3 { margin: 0 0 10px 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    label { font-weight: 600; font-size: 14px; display:block; margin-bottom: 4px; }
    input[type="text"], input[type="number"], input[type="date"], input[type="email"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: white;
    }
    .inline { display: inline-flex; align-items: center; gap: 8px; }
    .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: #111827; color: white; cursor: pointer; }
    button.secondary { background: #fff; color:#111827; }
    .success { color: #0a7f2e; }
    .error { color: #b00020; white-space: pre-wrap; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <h1>Verkoopovereenkomst — Volledig formulier</h1>
  <div class="muted">Dit formulier wordt automatisch opgebouwd op basis van het <code>/schema</code> van je API. Vul je API-url in en klik "Laad schema".</div>

  <div class="card" style="margin-top:12px;">
    <div class="inline">
      <div style="flex:1;">
        <label>API Base URL (Render)</label>
        <input id="apiBase" placeholder="https://jouw-naam.onrender.com"/>
        <div class="small muted">Voorbeeld: <code>https://verkoopovereenkomst.onrender.com</code></div>
      </div>
      <div class="actions" style="margin-left:auto;">
        <button id="btnLoadSchema">Laad schema</button>
        <button id="btnExample" class="secondary">Voorbeeld invullen</button>
      </div>
    </div>
    <div id="schemaStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <div id="formArea" class="card" style="margin-top:16px; display:none;">
    <h2 style="margin:0 0 8px 0;">Formulier</h2>
    <div id="sections"></div>
    <div class="actions" style="margin-top:14px;">
      <button id="btnValidate">Controleer invoer</button>
      <button id="btnGenerate">Genereer DOCX</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <details>
      <summary>Geavanceerd: JSON bekijken/bewerken</summary>
      <div class="row" style="margin-top:10px;">
        <div class="card" style="border-style:solid;">
          <label>JSON</label>
          <textarea id="jsonOut" spellcheck="false" style="min-height:320px;"></textarea>
        </div>
        <div class="card" style="border-style:solid;">
          <label>Validatiefouten</label>
          <pre id="errorsBox" class="small error" style="min-height:320px;"></pre>
        </div>
      </div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnFormToJson" class="secondary">Formulier → JSON</button>
        <button id="btnJsonToForm" class="secondary">JSON → Formulier</button>
      </div>
    </details>
  </div>

<script>
let schema = null;

function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) {
    if (k === "class") e.className = v;
    else if (k === "for") e.htmlFor = v;
    else e.setAttribute(k, v);
  }
  for (const c of [].concat(children)) {
    if (typeof c === "string") e.appendChild(document.createTextNode(c));
    else if (c) e.appendChild(c);
  }
  return e;
}
function fieldId(path) { return "f_" + path.join("__"); }

function renderField(path, key, propSchema) {
  const id = fieldId(path.concat([key]));
  const label = el("label", {"for": id}, [key.replaceAll("_"," ")]);
  let input;
  let t = propSchema.type;
  if (Array.isArray(t)) t = t[0];

  if (t === "boolean") {
    input = el("input", {type:"checkbox", id});
  } else if (t === "number" || t === "integer") {
    input = el("input", {type:"number", id, step:"any"});
  } else if (t === "string" && propSchema.format === "date") {
    input = el("input", {type:"date", id});
  } else if (t === "string" && propSchema.format === "email") {
    input = el("input", {type:"email", id});
  } else if (t === "string" && propSchema.enum) {
    const sel = el("select", {id});
    sel.appendChild(el("option", {value:""}, ["— kies —"]));
    for (const opt of propSchema.enum) sel.appendChild(el("option", {value:String(opt)}, [String(opt)]));
    input = sel;
  } else if (t === "string") {
    input = el("input", {type:"text", id});
  } else if (t === "object") {
    return renderObject(path.concat([key]), propSchema, key);
  } else {
    input = el("input", {type:"text", id});
  }
  return el("div", {}, [label, input]);
}

function renderObject(path, objSchema, title) {
  const section = el("div", {class:"section"});
  section.appendChild(el("h3", {}, [title.replaceAll("_"," ")]));
  const grid = el("div", {class:"grid"});
  section.appendChild(grid);
  const props = objSchema.properties || {};
  for (const [k, v] of Object.entries(props)) {
    if (v && v.type === "object") grid.appendChild(renderObject(path.concat([k]), v, k));
    else grid.appendChild(renderField(path, k, v || {}));
  }
  return section;
}

function buildForm(s) {
  const sections = document.getElementById("sections");
  sections.innerHTML = "";
  const props = s.properties || {};
  for (const [k, v] of Object.entries(props)) {
    sections.appendChild(renderObject([k], v, k));
  }
  document.getElementById("formArea").style.display = "block";
}

function setValueByPath(path, value) {
  const id = fieldId(path);
  const input = document.getElementById(id);
  if (!input) return;
  if (input.type === "checkbox") input.checked = Boolean(value);
  else input.value = value == null ? "" : value;
}
function getValueByPath(path) {
  const id = fieldId(path);
  const input = document.getElementById(id);
  if (!input) return undefined;
  if (input.type === "checkbox") return input.checked;
  if (input.type === "number") return input.value ? Number(input.value) : undefined;
  return input.value || undefined;
}
function objFromSchema(objSchema, basePath) {
  const props = objSchema.properties || {};
  const out = {};
  for (const [k, v] of Object.entries(props)) {
    if (v && v.type === "object") out[k] = objFromSchema(v, basePath.concat([k]));
    else {
      const val = getValueByPath(basePath.concat([k]));
      if (val !== undefined) out[k] = val;
    }
  }
  return out;
}
function fillFormFromObject(obj, basePath=[]) {
  for (const [k, v] of Object.entries(obj || {})) {
    if (v && typeof v === "object" && !Array.isArray(v)) fillFormFromObject(v, basePath.concat([k]));
    else setValueByPath(basePath.concat([k]), v);
  }
}

async function fetchSchema(apiBase) {
  const res = await fetch(apiBase + "/schema");
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function validateContext(apiBase, ctx) {
  const res = await fetch(apiBase + "/validate", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({context: ctx})
  });
  if (res.ok) return {ok:true, errors:[]};
  let text = await res.text();
  try {
    const j = JSON.parse(text);
    return {ok:false, errors:j.detail || [j]};
  } catch { return {ok:false, errors:[{message:text}]}; }
}
async function generateDocx(apiBase, ctx) {
  const res = await fetch(apiBase + "/genereer/docx", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({context: ctx})
  });
  if (!res.ok) throw new Error(await res.text());
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "overeenkomst.docx";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

document.getElementById("btnLoadSchema").addEventListener("click", async () => {
  const apiBase = document.getElementById("apiBase").value.trim();
  const s = document.getElementById("schemaStatus");
  s.textContent = "Schema laden...";
  try {
    schema = await fetchSchema(apiBase);
    buildForm(schema);
    s.textContent = "Schema geladen ✓";
  } catch (e) { s.textContent = "Fout: " + e.message; }
});
document.getElementById("btnExample").addEventListener("click", () => {
  const example = {
    "makelaar": {"naam":"Jan Jansen","biv_nummer":"123456","kantoor":"Immo Jansen","straat":"Stationsstraat","nummer":"12","postcode":"1000","gemeente":"Brussel"},
    "verkoper": {"natuurlijk_persoon": true, "naam":"Piet","voornaam":"Pieter","contact":{"email":"piet@example.com","telefoonnummer":"012345678"}},
    "koper": {"natuurlijk_persoon": true, "naam":"Klara","voornaam":"Klaartje","contact":{"email":"klara@example.com","telefoonnummer":"098765432"}},
    "goed": {"straat":"Dorpsplein","nummer":"1","postcode":"8500","gemeente":"Kortrijk","land":"België","aard":"Woning"},
    "prijs": {"totaal":350000,"voorschot":{"bedrag":35000,"overschrijving":true,"als_voorschot":true},"saldo_koopsom":315000},
    "genot":{"niet_verhuurd": true},
    "roerende_goederen":{"geen": true}
  };
  fillFormFromObject(example, []);
  document.getElementById("jsonOut").value = JSON.stringify(example, null, 2);
});
document.getElementById("btnFormToJson").addEventListener("click", () => {
  if (!schema) { alert("Laad eerst het schema."); return; }
  const ctx = objFromSchema(schema, []);
  document.getElementById("jsonOut").value = JSON.stringify(ctx, null, 2);
});
document.getElementById("btnJsonToForm").addEventListener("click", () => {
  try {
    const obj = JSON.parse(document.getElementById("jsonOut").value);
    fillFormFromObject(obj, []);
  } catch (e) { alert("JSON is ongeldig: " + e.message); }
});
document.getElementById("btnValidate").addEventListener("click", async () => {
  const apiBase = document.getElementById("apiBase").value.trim();
  const msg = document.getElementById("msg");
  if (!schema) { msg.textContent = "Laad eerst het schema."; msg.className = "error"; return; }
  const ctx = objFromSchema(schema, []);
  const res = await validateContext(apiBase, ctx);
  if (res.ok) { msg.textContent = "Valide ✓"; msg.className = "success"; document.getElementById("errorsBox").textContent = ""; }
  else {
    msg.textContent = "Fouten gevonden."; msg.className = "error";
    const lines = res.errors.map(e => `• ${e.path || ""} — ${e.message || JSON.stringify(e)}`);
    document.getElementById("errorsBox").textContent = lines.join("
");
  }
  document.getElementById("jsonOut").value = JSON.stringify(ctx, null, 2);
});
document.getElementById("btnGenerate").addEventListener("click", async () => {
  const apiBase = document.getElementById("apiBase").value.trim();
  const msg = document.getElementById("msg");
  if (!schema) { msg.textContent = "Laad eerst het schema."; msg.className = "error"; return; }
  const ctx = objFromSchema(schema, []);
  try {
    const v = await validateContext(apiBase, ctx);
    if (!v.ok) {
      msg.textContent = "Corrigeer de fouten vóór genereren."; msg.className = "error";
      const lines = v.errors.map(e => `• ${e.path || ""} — ${e.message || JSON.stringify(e)}`);
      document.getElementById("errorsBox").textContent = lines.join("
");
      document.getElementById("jsonOut").value = JSON.stringify(ctx, null, 2);
      return;
    }
    await generateDocx(apiBase, ctx);
    msg.textContent = "DOCX gegenereerd ✓"; msg.className = "success";
  } catch (e) { msg.textContent = "Fout: " + e.message; msg.className = "error"; }
});
</script>
</body>
</html>
